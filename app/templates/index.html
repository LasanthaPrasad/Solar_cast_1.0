{% extends "base.html" %}

{% block content %}







<div class="container-fluid dashboard">
    <h1 class="mb-4">GeoClipz Dashboard</h1>



    <div class="row mb-4">
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <h5 class="card-title">Total Active Installed Capacity</h5>
                    <h2 class="display-4">{{ total_capacity|round(2) }} MW</h2>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <h5 class="card-title">Total Real-time MW</h5>
                    <h2 class="display-4">{{ total_mw|round(2) }} MW</h2>
                </div>
            </div>
        </div>
        <!-- Add more summary cards here if needed -->
    </div>


















    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Aggregated Solar Generation Forecast of All Grid Substations</h5>
                    <button class="btn btn-sm btn-outline-secondary fullscreen-btn" data-target="forecastChart">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div id="forecastChart" class="chart-container" style="width:100%; height:400px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">GHI Forecast Comparison</h5>
                    <button class="btn btn-sm btn-outline-secondary fullscreen-btn" data-target="ghiComparisonChart">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div id="ghiComparisonChart" class="chart-container" style="width:100%; height:400px;"></div>
                </div>
            </div>
        </div>
    </div>



































    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Geographic Overview</h5>
                    <button class="btn btn-sm btn-outline-secondary fullscreen-btn" data-target="mapContainer">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="mapContainer" class="chart-container">
                        <div id="map" style="width:100%; height:600px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div class="mt-4" id="map" style="height: 800px;"></div>
{% endblock %}

{% block extra_js %}

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>

var forecastChart = echarts.init(document.getElementById('forecastChart'));
    var ghiComparisonChart = echarts.init(document.getElementById('ghiComparisonChart'));
    // ... (your chart initialization code)



    // Fullscreen functionality
    document.querySelectorAll('.fullscreen-btn').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const container = document.getElementById(targetId);
            
            if (!document.fullscreenElement) {
                if (container.requestFullscreen) {
                    container.requestFullscreen();
                } else if (container.mozRequestFullScreen) {
                    container.mozRequestFullScreen();
                } else if (container.webkitRequestFullscreen) {
                    container.webkitRequestFullscreen();
                } else if (container.msRequestFullscreen) {
                    container.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        });
    });

    // Handle fullscreen change event
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);
    document.addEventListener('MSFullscreenChange', handleFullscreenChange);

    function handleFullscreenChange() {
        const fullscreenElement = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
        if (fullscreenElement) {
            fullscreenElement.classList.add('fullscreen-active');
            resizeChart(fullscreenElement.id);
            updateChartBackground(fullscreenElement.id, 'white');
        } else {
            document.querySelectorAll('.chart-container').forEach(container => {
                container.classList.remove('fullscreen-active');
                resizeChart(container.id);
                updateChartBackground(container.id, 'white');
            });
        }
    }

    function resizeChart(containerId) {
        const container = document.getElementById(containerId);
        const chart = container.querySelector('div');
        if (container.classList.contains('fullscreen-active')) {
            chart.style.height = '90vh';
        } else {
            chart.style.height = '400px';
        }
        if (containerId === 'forecastChartContainer') {
            forecastChart.resize();
        } else if (containerId === 'ghiComparisonChartContainer') {
            ghiComparisonChart.resize();
        }
    }

    // Handle ESC key to exit fullscreen
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.fullscreenElement) {
            document.exitFullscreen();
        }
    });

    // Resize charts when window is resized
    window.addEventListener('resize', function() {
        forecastChart.resize();
        ghiComparisonChart.resize();
    });





























fetch('/api/ghi_comparison')
    .then(response => response.json())
    .then(data => {
        var series = [];
        var xAxis = [];

        // Find the earliest and latest timestamps across all providers
        let earliestTime = new Date('9999-12-31T23:59:59Z');
        let latestTime = new Date('1970-01-01T00:00:00Z');
        ScriptProcessorNode
        for (const locationData of Object.values(data)) {
            const firstTime = new Date(locationData.timestamps[0]);
            const lastTime = new Date(locationData.timestamps[locationData.timestamps.length - 1]);
            if (firstTime < earliestTime) earliestTime = firstTime;
            if (lastTime > latestTime) latestTime = lastTime;
        }

        // Create a full time range with 30-minute intervals
        let fullTimeRange = [];
        let currentTime = new Date(earliestTime);
        while (currentTime <= latestTime) {
            fullTimeRange.push(new Date(currentTime));
            currentTime.setMinutes(currentTime.getMinutes() + 30);
        }

        for (const [locationId, locationData] of Object.entries(data)) {
            let alignedData = new Array(fullTimeRange.length).fill(null);
            
            locationData.timestamps.forEach((timestamp, index) => {
                let time = new Date(timestamp);
                let position = fullTimeRange.findIndex(t => t.getTime() === time.getTime());
                if (position !== -1) {
                    alignedData[position] = [time.getTime(), locationData.ghi[index]];
                }
            });

            // Filter out null values
            alignedData = alignedData.filter(point => point !== null);

            series.push({
                name: locationData.name,
                type: 'line',
                data: alignedData,
                smooth: true,
                showSymbol: true,
                connectNulls: true
            });
        }

        xAxis = fullTimeRange.map(time => time.toLocaleString());

        // Create the chart
        var chart = echarts.init(document.getElementById('ghiComparisonChart'));
        chart.setOption({
            title: {
                text: ''
            },
            tooltip: {
                trigger: 'axis',
                formatter: function (params) {
                    var result = params[0].axisValueLabel + '<br/>';
                    params.forEach(function (item) {
                        result += item.marker + ' ' + item.seriesName + ': ' + item.data[1] + ' W/m²<br/>';
                    });
                    return result;
                }
            },
            legend: {
                data: series.map(s => s.name)
            },
            xAxis: {
                type: 'time',
                axisLabel: {
                    formatter: function (value) {
                        var date = new Date(value);
                        return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + 
                               '\n' + date.toLocaleDateString();
                    }
                }
            },
            yAxis: {
                type: 'value',
                name: 'GHI (W/m²)'
            },
            series: series
        });
    });









    document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/aggregate_grid_forecast')
        .then(response => response.json())
        .then(data => {
            var chart = echarts.init(document.getElementById('forecastChart'));
            
            var option = {
                title: {
                    text: ''
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        var date = new Date(params[0].value[0]);
                        return date.toLocaleString() + '<br />' +
                               params.map(param => 
                                   param.seriesName + ': ' + param.value[1].toFixed(2) + ' MW'
                               ).join('<br />');
                    }
                },
                legend: {
                    data: ['Interpolated Data', 'Actual Data Points'],
                    bottom: 0
                },
                xAxis: {
                    type: 'time',
                    axisLabel: {
                        formatter: function (value) {
                            var date = new Date(value);
                            return echarts.format.formatTime('HH:mm\nyyyy-MM-dd', date);
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'Total Estimated MW'
                },
                series: [{
                    name: 'Interpolated Data',
                    type: 'line',
                    smooth: true,
                    symbol: 'none',
                    data: data.timestamps.map((t, i) => [new Date(t), data.total_estimated_mw[i]]),
                    lineStyle: {

                        width: 2
                    }
                }, {
                    name: 'Actual Data Points',
                    type: 'scatter',
                    data: data.original_timestamps.map((t, i) => [new Date(t), data.original_total_estimated_mw[i]]),

                    symbolSize: 8
                }]
            };

            chart.setOption(option);

            // Handle window resize
            window.addEventListener('resize', function() {
                chart.resize();
            });
        })
        .catch(error => console.error('Error:', error));
});




















function initMap() {
    const map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 7.8731, lng: 80.7718 },  // Center of Sri Lanka
        zoom: 8,
    });

    const locations = [
        {% if forecast_locations %}
            {% for location in forecast_locations %}
            {
                position: { lat: {{ location.latitude }}, lng: {{ location.longitude }} },
                title: "{{ location.provider_name }}",
                content: "<h6>{{ location.provider_name }}</h6>" +
                         "<p>Latitude: {{ location.latitude }}<br>" +
                         "Longitude: {{ location.longitude }}<br>" +
                         "GHI: {{ location.ghi|default('N/A') }}<br>" +
                         "DNI: {{ location.dni|default('N/A') }}<br>" +
                         "DHI: {{ location.dhi|default('N/A') }}</p>"
            },
            {% endfor %}
        {% endif %}
    ];

    console.log("Number of locations:", locations.length);

    const infoWindow = new google.maps.InfoWindow();

    locations.forEach(location => {
        const marker = new google.maps.Marker({
            position: location.position,
            map: map,
            title: location.title
        });

        marker.addListener("click", () => {
            infoWindow.close();
            infoWindow.setContent(location.content);
            infoWindow.open(map, marker);
        });
    });
}


document.addEventListener("DOMContentLoaded", initMap);









document.querySelectorAll('.fullscreen-btn').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const chartContainer = document.getElementById(targetId);
            
            if (!document.fullscreenElement) {
                if (chartContainer.requestFullscreen) {
                    chartContainer.requestFullscreen();
                } else if (chartContainer.mozRequestFullScreen) { // Firefox
                    chartContainer.mozRequestFullScreen();
                } else if (chartContainer.webkitRequestFullscreen) { // Chrome, Safari and Opera
                    chartContainer.webkitRequestFullscreen();
                } else if (chartContainer.msRequestFullscreen) { // IE/Edge
                    chartContainer.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) { // Firefox
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) { // Chrome, Safari and Opera
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { // IE/Edge
                    document.msExitFullscreen();
                }
            }
        });
    });

    // Handle fullscreen change event
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);
    document.addEventListener('MSFullscreenChange', handleFullscreenChange);

    function handleFullscreenChange() {
        const fullscreenElement = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
        if (fullscreenElement) {
            fullscreenElement.style.height = '100vh';
            if (fullscreenElement.id === 'forecastChart') {
                forecastChart.resize();
            } else if (fullscreenElement.id === 'ghiComparisonChart') {
                ghiComparisonChart.resize();
            }
        } else {
            document.querySelectorAll('.chart-container').forEach(container => {
                container.style.height = '400px';
            });
            forecastChart.resize();
            ghiComparisonChart.resize();
        }
    }

    // Handle ESC key to exit fullscreen
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.fullscreenElement) {
            document.exitFullscreen();
        }
    });





























</script>
{% endblock %}