{% extends "base.html" %}

{% block content %}
<h1>GeoClipz Dashboard</h1>
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Active Installed Capacity</h5>
                <p class="card-text">{{ total_capacity|round(2) }} MW</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Real-time MW</h5>
                <p class="card-text">{{ total_mw|round(2) }} MW</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Aggregated Forecast for All Grid Substations</h5>
                <div id="forecastChart" style="width:100%; height:600px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">GHI Forecast Comparison</h5>
                <div id="ghiComparisonChart" style="width:100%; height:400px;"></div>
            </div>
        </div>
    </div>
</div>


<div class="mt-4" id="map" style="height: 800px;"></div>
{% endblock %}

{% block extra_js %}

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>

fetch('/api/ghi_comparison')
    .then(response => response.json())
    .then(data => {
        var series = [];
        var xAxis = [];

        // Find the earliest and latest timestamps across all providers
        let earliestTime = new Date('9999-12-31T23:59:59Z');
        let latestTime = new Date('1970-01-01T00:00:00Z');
        
        for (const locationData of Object.values(data)) {
            const firstTime = new Date(locationData.timestamps[0]);
            const lastTime = new Date(locationData.timestamps[locationData.timestamps.length - 1]);
            if (firstTime < earliestTime) earliestTime = firstTime;
            if (lastTime > latestTime) latestTime = lastTime;
        }

        // Create a full time range with 30-minute intervals
        let fullTimeRange = [];
        let currentTime = new Date(earliestTime);
        while (currentTime <= latestTime) {
            fullTimeRange.push(new Date(currentTime));
            currentTime.setMinutes(currentTime.getMinutes() + 30);
        }

        for (const [locationId, locationData] of Object.entries(data)) {
            let alignedData = new Array(fullTimeRange.length).fill(null);
            
            locationData.timestamps.forEach((timestamp, index) => {
                let time = new Date(timestamp);
                let position = fullTimeRange.findIndex(t => t.getTime() === time.getTime());
                if (position !== -1) {
                    alignedData[position] = locationData.ghi[index];
                }
            });

            series.push({
                name: locationData.name,
                type: 'line',
                data: alignedData
            });
        }

        xAxis = fullTimeRange.map(time => time.toLocaleString());

        // Create the chart
        var chart = echarts.init(document.getElementById('ghiComparisonChart'));
        chart.setOption({
            title: {
                text: ''
            },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: series.map(s => s.name)
            },
            xAxis: {
                type: 'category',
                data: xAxis
            },
            yAxis: {
                type: 'value',
                name: 'GHI (W/mÂ²)'
            },
            series: series
        });
    });


    document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/aggregate_grid_forecast')
        .then(response => response.json())
        .then(data => {
            var chart = echarts.init(document.getElementById('forecastChart'));
            
            var option = {
                title: {
                    text: 'Aggregate Forecast for All Grid Substations'
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        var date = new Date(params[0].value[0]);
                        return date.toLocaleString() + '<br />' +
                               params.map(param => 
                                   param.seriesName + ': ' + param.value[1].toFixed(2) + ' MW'
                               ).join('<br />');
                    }
                },
                legend: {
                    data: ['Interpolated Data', 'Actual Data Points'],
                    bottom: 0
                },
                xAxis: {
                    type: 'time',
                    axisLabel: {
                        formatter: function (value) {
                            var date = new Date(value);
                            return echarts.format.formatTime('HH:mm\nyyyy-MM-dd', date);
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'Total Estimated MW'
                },
                series: [{
                    name: 'Interpolated Data',
                    type: 'line',
                    smooth: true,
                    symbol: 'none',
                    data: data.timestamps.map((t, i) => [new Date(t), data.total_estimated_mw[i]]),
                    lineStyle: {
                        color: 'blue',
                        width: 2
                    }
                }, {
                    name: 'Actual Data Points',
                    type: 'scatter',
                    data: data.original_timestamps.map((t, i) => [new Date(t), data.original_total_estimated_mw[i]]),
                    itemStyle: {
                        color: 'red'
                    },
                    symbolSize: 8
                }]
            };

            chart.setOption(option);

            // Handle window resize
            window.addEventListener('resize', function() {
                chart.resize();
            });
        })
        .catch(error => console.error('Error:', error));
});




















function initMap() {
    const map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 7.8731, lng: 80.7718 },  // Center of Sri Lanka
        zoom: 8,
    });

    const locations = [
        {% if forecast_locations %}
            {% for location in forecast_locations %}
            {
                position: { lat: {{ location.latitude }}, lng: {{ location.longitude }} },
                title: "{{ location.provider_name }}",
                content: "<h6>{{ location.provider_name }}</h6>" +
                         "<p>Latitude: {{ location.latitude }}<br>" +
                         "Longitude: {{ location.longitude }}<br>" +
                         "GHI: {{ location.ghi|default('N/A') }}<br>" +
                         "DNI: {{ location.dni|default('N/A') }}<br>" +
                         "DHI: {{ location.dhi|default('N/A') }}</p>"
            },
            {% endfor %}
        {% endif %}
    ];

    console.log("Number of locations:", locations.length);

    const infoWindow = new google.maps.InfoWindow();

    locations.forEach(location => {
        const marker = new google.maps.Marker({
            position: location.position,
            map: map,
            title: location.title
        });

        marker.addListener("click", () => {
            infoWindow.close();
            infoWindow.setContent(location.content);
            infoWindow.open(map, marker);
        });
    });
}


document.addEventListener("DOMContentLoaded", initMap);
</script>
{% endblock %}